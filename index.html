<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>양육행동 평가척도 (Parenting Behavior Inventory)</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        h2 {
            color: #333;
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .header-info {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .header-info label {
            margin-right: 10px;
            font-weight: bold;
        }
        .header-info input, .header-info select {
            margin-right: 20px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        td:first-child {
            text-align: left;
            width: 40%;
        }
        .radio-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .radio-group label {
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }
        .radio-group label:hover {
            background-color: #f0f0f0;
        }
        .radio-group input[type="radio"]:checked + span {
            font-weight: bold;
            color: #4CAF50;
        }
        .problem-check {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .problem-check label {
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }
        .problem-check label:hover {
            background-color: #f0f0f0;
        }
        .problem-check input[type="radio"]:checked + span {
            font-weight: bold;
            color: #4CAF50;
        }
        .score-display {
            margin-top: 30px;
            padding: 20px;
            background-color: #e8f5e9;
            border-radius: 5px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .frequency-labels {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 16px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .save-btn {
            background-color: #2196F3;
        }
        .save-btn:hover {
            background-color: #1976D2;
        }
        .export-btn {
            background-color: #4285f4;
        }
        .export-detail-btn {
            background-color: #34a853;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
        }
        .tab.active {
            background-color: white;
            border-bottom: 2px solid white;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        tr.active-row {
            background-color: #fffde7;
        }
        .active-cell {
            background-color: #fff9c4 !important;
            outline: 2px solid #4CAF50;
        }
        .keyboard-help {
            margin-top: 20px;
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 5px;
            font-size: 14px;
        }
        .keyboard-help h4 {
            margin-top: 0;
            color: #1976d2;
        }
        .keyboard-help ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        .keyboard-help li {
            margin-bottom: 5px;
        }
        .history-table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
        }
        .history-table th, .history-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        .csv-output {
            margin-top: 20px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .csv-output textarea {
            width: 100%;
            height: 300px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>양육행동 평가척도</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('input')">평가 입력</div>
            <div class="tab" onclick="switchTab('history')">평가 기록</div>
            <div class="tab" onclick="switchTab('graph')">변화 추이</div>
        </div>

        <div id="input-tab" class="tab-content active">
            <div class="header-info">
                <label>날짜:</label>
                <input type="date" id="date">
                <label>실시자:</label>
                <select id="parent">
                    <option value="부">아버지</option>
                    <option value="모">어머니</option>
                </select>
                <label>자녀 이름:</label>
                <input type="text" id="childName">
            </div>

            <div class="section-title">♠ 아래는 여러분의 자녀의 행동에 관련된 질문들입니다.</div>
            <p>여러분의 자녀는 현재 다음의 행동들을 얼마나 자주 합니까? 또, 현재 아동의 이 행동이 여러분에게 문제가 됩니까?</p>
            
            <div class="frequency-labels">
                현재 자녀가 얼마나 자주 이런 행동을 합니까?<br>
                ① 전혀 안그렇다 ② 아주 가끔 ③ 가끔 ④ 절반정도 ⑤ 자주 ⑥ 매우 자주 ⑦ 항상 그렇다
            </div>

            <table>
                <thead>
                    <tr>
                        <th>행동 항목</th>
                        <th>빈도 평가 (1-7)</th>
                        <th>문제가 됩니까? (Y/N)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="background-color: #e3f2fd; font-weight: bold;">
                        <td>전체 항목 일괄 적용</td>
                        <td>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="freq_all" value="1" onchange="applyToAll('freq', '1')">
                                    <span>1</span>
                                </label>
                                <label>
                                    <input type="radio" name="freq_all" value="2" onchange="applyToAll('freq', '2')">
                                    <span>2</span>
                                </label>
                                <label>
                                    <input type="radio" name="freq_all" value="3" onchange="applyToAll('freq', '3')">
                                    <span>3</span>
                                </label>
                                <label>
                                    <input type="radio" name="freq_all" value="4" onchange="applyToAll('freq', '4')">
                                    <span>4</span>
                                </label>
                                <label>
                                    <input type="radio" name="freq_all" value="5" onchange="applyToAll('freq', '5')">
                                    <span>5</span>
                                </label>
                                <label>
                                    <input type="radio" name="freq_all" value="6" onchange="applyToAll('freq', '6')">
                                    <span>6</span>
                                </label>
                                <label>
                                    <input type="radio" name="freq_all" value="7" onchange="applyToAll('freq', '7')">
                                    <span>7</span>
                                </label>
                                <button onclick="clearAllFreq()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">초기화</button>
                            </div>
                        </td>
                        <td>
                            <div class="problem-check">
                                <label>
                                    <input type="radio" name="prob_all" value="Y" onchange="applyToAll('prob', 'Y')">
                                    <span>예</span>
                                </label>
                                <label>
                                    <input type="radio" name="prob_all" value="N" onchange="applyToAll('prob', 'N')">
                                    <span>아니오</span>
                                </label>
                                <button onclick="clearAllProb()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background-color: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">초기화</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
                <tbody id="items">
                    <!-- 항목들이 여기에 동적으로 생성됩니다 -->
                </tbody>
            </table>

            <div class="keyboard-help">
                <h4>키보드 단축키 안내</h4>
                <ul>
                    <li><strong>1-7 숫자키:</strong> 빈도 평가 점수 입력</li>
                    <li><strong>Y/N 키:</strong> 문제 여부 입력 (예/아니오)</li>
                    <li><strong>방향키 ↓↑:</strong> 다음/이전 문항으로 이동</li>
                    <li><strong>방향키 →←:</strong> 빈도 평가 ↔ 문제 여부 칸 이동</li>
                    <li><strong>Enter 키:</strong> 다음 문항으로 이동</li>
                    <li><strong>Tab 키:</strong> 다음 입력 칸으로 이동</li>
                </ul>
                <p style="color: #1976d2; font-weight: bold; margin-top: 10px;">
                    ※ 상단의 '전체 항목 일괄 적용' 행에서 선택하면 모든 항목에 동일한 값을 적용할 수 있습니다.
                </p>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="calculateScores()">점수 계산하기</button>
                <button class="save-btn" onclick="saveScores()">평가 결과 저장하기</button>
                <button class="export-btn" onclick="exportToCSV()">CSV로 내보내기</button>
                <button class="export-detail-btn" onclick="exportDetailedResults()">상세 결과 내보내기</button>
            </div>

            <div class="score-display" id="scoreDisplay">
                총 점수와 문제 행동 개수가 여기에 표시됩니다.
            </div>
        </div>

        <div id="history-tab" class="tab-content">
            <h2>평가 기록</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>날짜</th>
                        <th>실시자</th>
                        <th>자녀 이름</th>
                        <th>총 점수</th>
                        <th>평균 점수</th>
                        <th>문제 행동 수</th>
                        <th>삭제</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- 기록이 여기에 표시됩니다 -->
                </tbody>
            </table>
        </div>

        <div id="graph-tab" class="tab-content">
            <h2>변화 추이</h2>
            <div class="chart-container">
                <h3>평가 결과 요약</h3>
                <div id="dataReport" style="padding: 20px;">
                    <p>데이터가 없습니다. 평가를 먼저 진행해주세요.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 평가 항목들
        const items = [
            "옷 입는데 꾸물거린다",
            "식사시간 중에 꾸물거린다",
            "식사예절이 나쁘다",
            "차려진 음식을 거부한다",
            "부탁한 가사 일을 거부한다",
            "취침 준비가 느리다",
            "제 시간에 취침하는 것을 거부한다",
            "자기와 관계있는 집안규칙에 복종하지 않는다",
            "벌로 위협할 때까지 말을 안 듣는다",
            "무엇을 하라고 말을 할 때 반항적인 태도를 보인다",
            "집안 규칙에 대해 부모와 다툰다",
            "자기 방식대로 못하면 화를 낸다",
            "감정격분 행동을 한다 (화를 내면서 그대로 주저앉거나 울며 발을 구르고 물건을 집어 던진다)",
            "어른에게 건방진 말대꾸를 한다",
            "투덜댄다",
            "쉽게 운다",
            "고함이나 소리를 지른다",
            "부모를 때린다",
            "장난감이나 다른 물건들을 부순다",
            "장난감이나 다른 물건들을 조심성 없게 다룬다",
            "도둑질한다",
            "거짓말한다",
            "다른 아이들을 놀리거나 화나게 한다",
            "또래 아이들과 말싸움을 한다",
            "형제/자매들과 말싸움을 한다",
            "또래 아이들과 몸싸움을 한다",
            "형제/자매들과 몸싸움을 한다",
            "계속 주목을 받고 싶어 한다",
            "방해를 한다",
            "쉽게 산만해진다",
            "주의집중 시간이 짧다",
            "일이나 숙제를 끝내지 못한다",
            "혼자서 노는 것이 어렵다",
            "한 가지 일에 집중하는 것이 어렵다",
            "과장된 행동을 보이거나 침착하지 못하다",
            "침대에 소변을 본다"
        ];

        // 데이터 저장소
        let dataStore = {
            history: []
        };

        let currentScores = null;
        let currentRow = 0;
        let currentColumn = 0;

        // 항목 생성 함수
        function createItems() {
            const container = document.getElementById('items');
            items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}. ${item}</td>
                    <td class="freq-cell" data-row="${index}" data-col="0">
                        <div class="radio-group">
                            ${[1,2,3,4,5,6,7].map(val => `
                                <label>
                                    <input type="radio" name="freq_${index}" value="${val}">
                                    <span>${val}</span>
                                </label>
                            `).join('')}
                        </div>
                    </td>
                    <td class="prob-cell" data-row="${index}" data-col="1">
                        <div class="problem-check">
                            <label>
                                <input type="radio" name="prob_${index}" value="Y">
                                <span>예</span>
                            </label>
                            <label>
                                <input type="radio" name="prob_${index}" value="N">
                                <span>아니오</span>
                            </label>
                        </div>
                    </td>
                `;
                container.appendChild(row);
            });
        }

        // 모든 항목에 동일한 값을 적용하는 함수
        function applyToAll(type, value) {
            items.forEach((item, index) => {
                const radio = document.querySelector(`input[name="${type}_${index}"][value="${value}"]`);
                if (radio) {
                    radio.checked = true;
                }
            });
        }

        // 빈도 평가 전체 초기화
        function clearAllFreq() {
            document.querySelectorAll('input[name="freq_all"]').forEach(radio => {
                radio.checked = false;
            });
            items.forEach((item, index) => {
                document.querySelectorAll(`input[name="freq_${index}"]`).forEach(radio => {
                    radio.checked = false;
                });
            });
        }

        // 문제 여부 전체 초기화
        function clearAllProb() {
            document.querySelectorAll('input[name="prob_all"]').forEach(radio => {
                radio.checked = false;
            });
            items.forEach((item, index) => {
                document.querySelectorAll(`input[name="prob_${index}"]`).forEach(radio => {
                    radio.checked = false;
                });
            });
        }

        // 현재 셀 하이라이트
        function highlightCell(row, col) {
            document.querySelectorAll('.active-row').forEach(el => el.classList.remove('active-row'));
            document.querySelectorAll('.active-cell').forEach(el => el.classList.remove('active-cell'));
            
            const rows = document.querySelectorAll('#items tr');
            if (rows[row]) {
                rows[row].classList.add('active-row');
            }
            
            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            if (cell) {
                cell.classList.add('active-cell');
                cell.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 키보드 이벤트 처리
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                if (!document.getElementById('input-tab').classList.contains('active')) {
                    return;
                }

                if (e.target.tagName === 'INPUT' && e.target.type === 'text') {
                    return;
                }

                switch(e.key) {
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                    case '5':
                    case '6':
                    case '7':
                        e.preventDefault();
                        if (currentColumn === 0) {
                            const radio = document.querySelector(`input[name="freq_${currentRow}"][value="${e.key}"]`);
                            if (radio) {
                                radio.checked = true;
                                moveToNextCell();
                            }
                        }
                        break;
                    
                    case 'y':
                    case 'Y':
                    case 'ㅛ':
                        e.preventDefault();
                        if (currentColumn === 1) {
                            const radio = document.querySelector(`input[name="prob_${currentRow}"][value="Y"]`);
                            if (radio) {
                                radio.checked = true;
                                moveToNextRow();
                            }
                        }
                        break;
                    
                    case 'n':
                    case 'N':
                    case 'ㅜ':
                        e.preventDefault();
                        if (currentColumn === 1) {
                            const radio = document.querySelector(`input[name="prob_${currentRow}"][value="N"]`);
                            if (radio) {
                                radio.checked = true;
                                moveToNextRow();
                            }
                        }
                        break;
                    
                    case 'ArrowDown':
                        e.preventDefault();
                        if (currentRow < items.length - 1) {
                            currentRow++;
                            highlightCell(currentRow, currentColumn);
                        }
                        break;
                    
                    case 'ArrowUp':
                        e.preventDefault();
                        if (currentRow > 0) {
                            currentRow--;
                            highlightCell(currentRow, currentColumn);
                        }
                        break;
                    
                    case 'ArrowRight':
                        e.preventDefault();
                        if (currentColumn < 1) {
                            currentColumn++;
                            highlightCell(currentRow, currentColumn);
                        }
                        break;
                    
                    case 'ArrowLeft':
                        e.preventDefault();
                        if (currentColumn > 0) {
                            currentColumn--;
                            highlightCell(currentRow, currentColumn);
                        }
                        break;
                    
                    case 'Enter':
                        e.preventDefault();
                        moveToNextCell();
                        break;
                    
                    case 'Tab':
                        setTimeout(() => {
                            updateCurrentPosition();
                        }, 0);
                        break;
                }
            });

            document.addEventListener('click', (e) => {
                const cell = e.target.closest('[data-row][data-col]');
                if (cell) {
                    currentRow = parseInt(cell.dataset.row);
                    currentColumn = parseInt(cell.dataset.col);
                    highlightCell(currentRow, currentColumn);
                }
            });
        }

        // 다음 셀로 이동
        function moveToNextCell() {
            if (currentColumn < 1) {
                currentColumn++;
            } else {
                currentColumn = 0;
                if (currentRow < items.length - 1) {
                    currentRow++;
                }
            }
            highlightCell(currentRow, currentColumn);
        }

        // 다음 행으로 이동
        function moveToNextRow() {
            currentColumn = 0;
            if (currentRow < items.length - 1) {
                currentRow++;
            }
            highlightCell(currentRow, currentColumn);
        }

        // 현재 포커스 위치 업데이트
        function updateCurrentPosition() {
            const focusedElement = document.activeElement;
            const cell = focusedElement.closest('[data-row][data-col]');
            if (cell) {
                currentRow = parseInt(cell.dataset.row);
                currentColumn = parseInt(cell.dataset.col);
                highlightCell(currentRow, currentColumn);
            }
        }

        // 점수 계산 함수
        function calculateScores() {
            let totalScore = 0;
            let problemCount = 0;
            let answeredItems = 0;

            items.forEach((item, index) => {
                const freqRadios = document.getElementsByName(`freq_${index}`);
                const probRadios = document.getElementsByName(`prob_${index}`);
                
                let itemAnswered = false;
                
                freqRadios.forEach(radio => {
                    if (radio.checked) {
                        totalScore += parseInt(radio.value);
                        itemAnswered = true;
                    }
                });
                
                if (itemAnswered) {
                    answeredItems++;
                }
                
                probRadios.forEach(radio => {
                    if (radio.checked && radio.value === 'Y') {
                        problemCount++;
                    }
                });
            });

            const averageScore = answeredItems > 0 ? (totalScore / answeredItems).toFixed(2) : 0;
            
            currentScores = {
                totalScore,
                answeredItems,
                averageScore,
                problemCount
            };

            const scoreDisplay = document.getElementById('scoreDisplay');
            scoreDisplay.innerHTML = `
                <h3>평가 결과</h3>
                <p><strong>총 점수:</strong> ${totalScore}점</p>
                <p><strong>응답한 문항 수:</strong> ${answeredItems}개 / ${items.length}개</p>
                <p><strong>평균 점수:</strong> ${averageScore}점</p>
                <p><strong>문제 행동으로 체크된 항목 수:</strong> ${problemCount}개</p>
            `;
        }

        // 점수 저장 함수
        function saveScores() {
            if (!currentScores) {
                alert('먼저 점수를 계산해주세요.');
                return;
            }

            const date = document.getElementById('date').value;
            const parent = document.getElementById('parent').value;
            const childName = document.getElementById('childName').value;

            if (!date || !childName) {
                alert('날짜와 자녀 이름을 입력해주세요.');
                return;
            }

            const record = {
                id: Date.now(),
                date,
                parent,
                childName,
                ...currentScores
            };

            dataStore.history.push(record);

            alert('평가 결과가 저장되었습니다. (주의: 페이지를 새로고침하면 데이터가 사라집니다)');
            loadHistory();
            updateDataReport();
        }

        // 기록 불러오기 함수
        function loadHistory() {
            const history = dataStore.history;
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';

            history.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.parent}</td>
                    <td>${record.childName}</td>
                    <td>${record.totalScore}</td>
                    <td>${record.averageScore}</td>
                    <td>${record.problemCount}</td>
                    <td><button class="delete-btn" onclick="deleteRecord(${record.id})">삭제</button></td>
                `;
                tbody.appendChild(row);
            });

            updateDataReport();
        }

        // 기록 삭제 함수
        function deleteRecord(id) {
            if (confirm('이 기록을 삭제하시겠습니까?')) {
                dataStore.history = dataStore.history.filter(record => record.id !== id);
                loadHistory();
            }
        }

        // 데이터 요약 업데이트 함수
        function updateDataReport() {
            const history = dataStore.history;
            const reportDiv = document.getElementById('dataReport');
            
            if (history.length === 0) {
                reportDiv.innerHTML = '<p>데이터가 없습니다. 평가를 먼저 진행해주세요.</p>';
                return;
            }

            const sortedHistory = history.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const totalScores = sortedHistory.map(record => record.totalScore);
            const averageScores = sortedHistory.map(record => parseFloat(record.averageScore));
            const problemCounts = sortedHistory.map(record => record.problemCount);
            
            const avgTotalScore = (totalScores.reduce((a, b) => a + b, 0) / totalScores.length).toFixed(2);
            const avgAvgScore = (averageScores.reduce((a, b) => a + b, 0) / averageScores.length).toFixed(2);
            const avgProblemCount = (problemCounts.reduce((a, b) => a + b, 0) / problemCounts.length).toFixed(2);
            
            let html = `
                <h4>전체 통계</h4>
                <ul>
                    <li>평가 횟수: ${history.length}회</li>
                    <li>평균 총점: ${avgTotalScore}점</li>
                    <li>평균 항목당 점수: ${avgAvgScore}점</li>
                    <li>평균 문제 행동 수: ${avgProblemCount}개</li>
                </ul>
                
                <h4>최근 변화 추이</h4>
                <table class="history-table" style="margin-top: 10px;">
                    <thead>
                        <tr>
                            <th>날짜</th>
                            <th>총점</th>
                            <th>평균</th>
                            <th>문제행동</th>
                            <th>이전 대비</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const recentData = sortedHistory.slice(-5).reverse();
            
            recentData.forEach((record, index) => {
                let changeText = '-';
                if (index < recentData.length - 1) {
                    const prevRecord = recentData[index + 1];
                    const change = record.totalScore - prevRecord.totalScore;
                    const changeClass = change > 0 ? 'increase' : change < 0 ? 'decrease' : 'same';
                    changeText = `<span class="${changeClass}">${change > 0 ? '+' : ''}${change}</span>`;
                }
                
                html += `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.totalScore}</td>
                        <td>${record.averageScore}</td>
                        <td>${record.problemCount}</td>
                        <td>${changeText}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <style>
                    .increase { color: #ff6b6b; font-weight: bold; }
                    .decrease { color: #4ecdc4; font-weight: bold; }
                    .same { color: #555; }
                </style>
            `;
            
            reportDiv.innerHTML = html;
        }

        // CSV 내보내기 함수
        function exportToCSV() {
            const history = dataStore.history;
            
            if (!history || history.length === 0) {
                displayCSVOutput('저장된 데이터가 없습니다. 먼저 평가를 진행하고 결과를 저장해주세요.');
                return;
            }
            
            let csvContent = '날짜,실시자,자녀이름,총점수,평균점수,문제행동수\n';
            
            history.forEach(record => {
                csvContent += `${record.date},${record.parent},${record.childName},${record.totalScore},${record.averageScore},${record.problemCount}\n`;
            });
            
            displayCSVOutput(csvContent, '전체 평가 기록');
        }

        // 개별 평가 결과 상세 내보내기 함수
        function exportDetailedResults() {
            if (!currentScores) {
                displayCSVOutput('먼저 점수를 계산해주세요.');
                return;
            }
            
            const date = document.getElementById('date').value;
            const parent = document.getElementById('parent').value;
            const childName = document.getElementById('childName').value;
            
            if (!date || !childName) {
                displayCSVOutput('날짜와 자녀 이름을 입력해주세요.');
                return;
            }
            
            let csvContent = `양육행동 평가 상세 결과\n`;
            csvContent += `날짜,${date}\n`;
            csvContent += `실시자,${parent}\n`;
            csvContent += `자녀 이름,${childName}\n\n`;
            csvContent += `총점,${currentScores.totalScore}\n`;
            csvContent += `응답한 문항수,${currentScores.answeredItems}\n`;
            csvContent += `평균점수,${currentScores.averageScore}\n`;
            csvContent += `문제행동수,${currentScores.problemCount}\n\n`;
            csvContent += `번호,항목,빈도평가,문제여부\n`;
            
            items.forEach((item, index) => {
                let freq = '-';
                let prob = '-';
                
                const freqRadios = document.getElementsByName(`freq_${index}`);
                freqRadios.forEach(radio => {
                    if (radio.checked) {
                        freq = radio.value;
                    }
                });
                
                const probRadios = document.getElementsByName(`prob_${index}`);
                probRadios.forEach(radio => {
                    if (radio.checked) {
                        prob = radio.value === 'Y' ? '예' : '아니오';
                    }
                });
                
                csvContent += `${index + 1},"${item}",${freq},${prob}\n`;
            });
            
            displayCSVOutput(csvContent, '상세 평가 결과');
        }

        // CSV 데이터를 화면에 표시하는 함수
        function displayCSVOutput(content, title = 'CSV 데이터') {
            const scoreDisplay = document.getElementById('scoreDisplay');
            
            // 기존 CSV 출력 영역이 있으면 업데이트, 없으면 생성
            let csvOutputDiv = scoreDisplay.querySelector('.csv-output');
            if (!csvOutputDiv) {
                csvOutputDiv = document.createElement('div');
                csvOutputDiv.className = 'csv-output';
                scoreDisplay.appendChild(csvOutputDiv);
            }
            
            if (typeof content === 'string' && content.includes(',')) {
                // CSV 데이터인 경우
                csvOutputDiv.innerHTML = `
                    <h3>${title}</h3>
                    <p>아래 텍스트를 전체 선택(Ctrl+A)하고 복사(Ctrl+C)한 후, 메모장에 붙여넣어 .csv 파일로 저장하세요.</p>
                    <textarea readonly>${content}</textarea>
                `;
                
                // 텍스트 영역 자동 선택
                const textarea = csvOutputDiv.querySelector('textarea');
                if (textarea) {
                    textarea.select();
                    textarea.scrollTop = 0;
                }
            } else {
                // 오류 메시지인 경우
                csvOutputDiv.innerHTML = `<p style="color: red;">${content}</p>`;
            }
        }

        // 탭 전환 함수
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'graph') {
                updateDataReport();
            }
        }

        // 페이지 로드 시 초기화
        function initialize() {
            createItems();
            setupKeyboardNavigation();
            loadHistory();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            highlightCell(0, 0);
        }

        // 페이지 로드 시 초기화
        window.onload = initialize;
    </script>
</body>
</html>